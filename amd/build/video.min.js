define("mod_video/video",["exports","mod_video/plyr","core/ajax","core/toast","core/str"],(function(_exports,_plyr,_ajax,Toast,_str){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_plyr=_interopRequireDefault(_plyr),_ajax=_interopRequireDefault(_ajax),Toast=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!==_typeof(obj)&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Toast);var Video=function(){function Video(cm,instance,options){var _options$sessionAggre;!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Video),this.cm=cm,this.instance=instance,this.options=options,this.session=null,this.elapsedseconds=0,this.maxTime=null!==(_options$sessionAggre=options.sessionAggregates.maxtime)&&void 0!==_options$sessionAggre?_options$sessionAggre:0,this.init()}var Constructor,protoProps,staticProps,_init;return Constructor=Video,protoProps=[{key:"init",value:(_init=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var stringKeys,_this=this;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return this.log("video:init:cm",this.cm),this.log("video:init:instance",this.instance),this.log("video:init:options",this.options),stringKeys=[{key:"cannotforwardseek",component:"mod_video"}],_context2.next=6,(0,_str.get_strings)(stringKeys);case 6:this.strings=_context2.sent,this.options.preventForwardSeeking&&(this.options.listeners={seek:function(e){if(_this.log("video:seek",_this.player.currentTime,e),_this.log("strings",_this.strings),_getTargetTime(_this.player,e)>_this.maxTime)return _this.log("video:preventff",_this.player.currentTime,e),document.querySelector(".toast-wrapper .toast")||Toast.add(_this.strings[0]),!1}}),this.player=new _plyr.default("#player-".concat(this.instance.id),this.options),this.log("video:player",this.player),this.options.sessionAggregates.lasttime&&(this.log("video:resume",this.options.sessionAggregates.lasttime),this.player.currentTime=parseInt(this.options.sessionAggregates.lasttime)),setInterval((function(){return _this.tick()}),1e3),setInterval((function(){return _this.recordUpdates()}),1e4),this.player.on("playing",_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var response;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(_this.sessionInitialized){_context.next=6;break}return _this.sessionInitialized=!0,_context.next=4,_this.createSession(_this.cm.id);case 4:response=_context.sent,_this.session=response.session;case 6:case"end":return _context.stop()}}),_callee)}))));case 14:case"end":return _context2.stop()}}),_callee2,this)}))),function(){return _init.apply(this,arguments)})},{key:"tick",value:function(){this.player&&this.player.playing&&(this.elapsedseconds+=this.player.speed,this.player.currentTime>this.maxTime&&(this.maxTime=this.player.currentTime))}},{key:"recordUpdates",value:function(){this.player&&this.elapsedseconds>0&&(_ajax.default.call([{methodname:"mod_video_record_session_updates",args:{sessionid:this.session.id,timeelapsed:this.elapsedseconds,currenttime:parseInt(this.player.currentTime),currentpercent:this.player.currentTime/this.player.duration}}]),this.elapsedseconds=0)}},{key:"createSession",value:function(cmid){return _ajax.default.call([{methodname:"mod_video_create_session",args:{cmid:cmid}}])[0]}},{key:"log",value:function(){if(this.options.debug){for(var _len=arguments.length,data=new Array(_len),_key=0;_key<_len;_key++)data[_key]=arguments[_key];console.log(data)}}}],protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Video}();function _getTargetTime(plyr,input){return"object"!==_typeof(input)||"input"!==input.type&&"change"!==input.type?Number(input):input.target.value/input.target.max*plyr.media.duration}return _exports.default=Video,_exports.default}));

//# sourceMappingURL=video.min.js.map